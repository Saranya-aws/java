pipeline {
    agent any

    tools {
        maven 'Maven3'
        jdk 'Java17'
    }

    environment {
        NEXUS_REPO = "http://3.27.120.170:8081/repository/maven-hosted/"
        NEXUS_CREDENTIALS = "saranya"
    }

    stages {

        stage('Checkout Code') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/Saranya-aws/java.git'
            }
        }

        stage('Build') {
            steps {
                sh "mvn clean install -DskipTests"
            }
        }
stage('Verify Artifact') {
    steps {
        script {
            def jarFile = findFiles(glob: 'target/*.jar')[0]
            if (!jarFile || jarFile.length() == 0) {
                error "Build failed: JAR is missing or empty!"
            } else {
                echo "JAR created successfully: ${jarFile.name}"
            }
        }
    }
}

        stage('Test') {
            steps {
                sh "mvn test"
            }
        }

        stage('Package') {
            steps {
                sh "mvn package"
            }
        }

        stage('Upload to Nexus') {
            steps {
                withCredentials([usernamePassword(credentialsId: "${NEXUS_CREDENTIALS}", 
                    usernameVariable: 'NEXUS_USER', passwordVariable: 'NEXUS_PASS')]) {

                    sh """
                        mvn deploy \
                        -DskipTests \
                        -Dnexus.user=$NEXUS_USER \
                        -Dnexus.pass=$NEXUS_PASS \
                        -DaltDeploymentRepository=nexus::default::${NEXUS_REPO}
                    """
                }
            }
        }
    }

    post {
        success {
            echo "Pipeline completed successfully and artifact uploaded to Nexus!"
        }
        failure {
            echo "Pipeline failed!"
        }
    }
}


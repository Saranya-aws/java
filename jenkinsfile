

          pipeline {
    agent any

    environment {
        REGISTRY = "saranyamagi"
        IMAGE_NAME = "java"
        VERSION = "1.0.65-SNAPSHOT"   // Change dynamically if needed
        FULL_IMAGE = "${REGISTRY}/${IMAGE_NAME}:${VERSION}"
    }

    stages {

        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Build & Test') {
            steps {
                echo 'Building and testing Java project...'
                sh "mvn clean package -Drevision=${VERSION}"
            }
        }

        stage('Upload to Nexus') {
            steps {
                echo 'Uploading artifact to Nexus repository...'
                nexusArtifactUploader artifacts: [[
                    artifactId: 'sample-java',
                    classifier: '',
                    file: "target/sample-java-${VERSION}.jar",
                    type: 'jar'
                ]],
                credentialsId: 'nexus-cred',
                groupId: 'com.saranya',
                nexusUrl: '52.62.116.202:8081',
                nexusVersion: 'nexus3',
                protocol: 'http',
                repository: 'spring-boot-app',
                version: "${VERSION}"
            }
        }

        stage('Check Docker Access') {
            steps {
                sh 'docker info'
            }
        }

        stage('Build Docker Image') {
            steps {
                echo "Building Docker image ${FULL_IMAGE}..."
                sh "docker build -t ${FULL_IMAGE} ."
            }
        }

        stage('Scan Docker Image') {
            steps {
                echo "Scanning Docker image ${FULL_IMAGE} with Trivy..."
                sh "trivy image --severity HIGH,CRITICAL --exit-code 1 ${FULL_IMAGE} || true"
            }
        }

        stage('Push Docker Image') {
            steps {
                echo "Pushing Docker image ${FULL_IMAGE} to Docker Hub..."
                withDockerRegistry([credentialsId: 'dockerhub-cred', url: '']) {
                    sh "docker push ${FULL_IMAGE}"
                }
            }
        }

        stage('Archive Artifacts') {
            steps {
                archiveArtifacts artifacts: "target/*.jar", fingerprint: true
            }
        }
    }

    post {
        always {
            echo 'Pipeline finished!'
        }
        success {
            echo 'Pipeline succeeded!'
        }
        failure {
            echo 'Pipeline failed!'
        }
    }
}


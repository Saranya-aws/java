
pipeline {
    agent any

    tools {
        maven 'Maven3'
        jdk 'Java17'
    }

    environment {
        // Trivy cache directory
        TRIVY_CACHE_DIR = "${JENKINS_HOME}/trivy-cache"
        NEXUS_URL  = "http://3.106.122.202:8081"
        NEXUS_REPO = "spring-boot-app"
        GROUP_ID   = "com.saranya"
        CRED_ID    = "nexus-cred" // Jenkins credentials ID
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '5'))
        timeout(time: 30, unit: 'MINUTES')
    }

    stages {

        stage('Checkout') {
            steps { 
                checkout scm 
            }
        }

        stage('Build with Maven') {
            steps {
                dir('java') {
                    sh 'mvn clean package'
                }
            }
        }

        stage('Archive Artifact') {
            steps {
                archiveArtifacts artifacts: 'java/target/*.jar', fingerprint: true
            }
        }

        stage('Upload to Nexus') {
            steps {
                script {
                    def artifact = sh(
                        script: "ls java/target/*.jar | head -1",
                        returnStdout: true
                    ).trim()

                    withCredentials([usernamePassword(
                        credentialsId: CRED_ID,
                        usernameVariable: 'NEXUS_USER',
                        passwordVariable: 'NEXUS_PASS'
                    )]) {
                        sh """
                        curl -v -u $NEXUS_USER:$NEXUS_PASS \
                        -F maven2.groupId=$GROUP_ID \
                        -F maven2.artifactId=SimpleJavaProject \
                        -F maven2.version=1.0.0 \
                        -F maven2.generate-pom=true \
                        -F maven2.asset=@${artifact} \
                        -F maven2.asset.extension=jar \
                        $NEXUS_URL/service/rest/v1/components?repository=$NEXUS_REPO
                        """
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('java') {
                    sh "docker build -t simplejavaproject:1.0.0 ."
                }
            }
        }

        stage('Scan Docker Image') {
            steps {
                sh """
                mkdir -p $TRIVY_CACHE_DIR
                chmod -R 755 $TRIVY_CACHE_DIR
                trivy image --cache-dir $TRIVY_CACHE_DIR --exit-code 1 --severity HIGH,CRITICAL simplejavaproject:1.0.0
                """
            }
        }
    }

    post {
        always {
            deleteDir() // Clean workspace
        }
        success {
            echo 'Build, Nexus deploy, Docker build, and Trivy scan completed successfully.'
        }
        failure {
            echo 'Build, Nexus deploy, Docker build, or Trivy scan failed. Check logs.'
        }
    }
}

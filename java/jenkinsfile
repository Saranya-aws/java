
pipeline {
    agent any

    tools {
        maven 'Maven3'
        jdk 'Java17'
    }

    environment {
        TRIVY_CACHE_DIR = "${JENKINS_HOME}/trivy-cache"
        NEXUS_URL       = "http://13.236.152.131:8081"
        NEXUS_REPO      = "spring-boot-app"
        GROUP_ID        = "com.saranya"
        CRED_ID         = "nexus-cred"
        DOCKER_REG      = "saranyamagi"
        DOCKER_CRED_ID  = "dockerhub-cred"
        IMAGE_NAME      = "simplejavaproject"
        IMAGE_TAG       = "1.0.0"
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '5'))
        timeout(time: 30, unit: 'MINUTES')
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build with Maven') {
            steps {
                dir('java') {
                    sh 'mvn clean package'
                }
            }
        }

        stage('Archive Artifact') {
            steps {
                archiveArtifacts artifacts: 'java/target/*.jar', fingerprint: true
            }
        }

        stage('Upload to Nexus') {
            steps {
                script {
                    def artifact = sh(script: "ls java/target/*.jar | head -1", returnStdout: true).trim()

                    withCredentials([usernamePassword(
                        credentialsId: CRED_ID,
                        usernameVariable: 'NEXUS_USER',
                        passwordVariable: 'NEXUS_PASS'
                    )]) {
                        sh """
                        curl -v -u $NEXUS_USER:$NEXUS_PASS \\
                        -F maven2.groupId=$GROUP_ID \\
                        -F maven2.artifactId=SimpleJavaProject \\
                        -F maven2.version=1.0.0 \\
                        -F maven2.generate-pom=true \\
                        -F maven2.asset=@${artifact} \\
                        -F maven2.asset.extension=jar \\
                        $NEXUS_URL/service/rest/v1/components?repository=$NEXUS_REPO
                        """
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('java') {
                    sh "docker build -t $DOCKER_REG/$IMAGE_NAME:$IMAGE_TAG ."
                }
            }
        }

        stage('Scan Docker Image') {
            steps {
                sh """
                mkdir -p $TRIVY_CACHE_DIR ~/trivy-tmp
                chmod -R 755 $TRIVY_CACHE_DIR ~/trivy-tmp
                export TMPDIR=~/trivy-tmp
                trivy image --cache-dir $TRIVY_CACHE_DIR --exit-code 1 --severity HIGH,CRITICAL $DOCKER_REG/$IMAGE_NAME:$IMAGE_TAG
                """
            }
        }

        stage('Push Docker Image') {
            steps {
                echo 'Pushing Docker image to Docker Hub...'
                script {
                    def dockerImage = docker.image("$DOCKER_REG/$IMAGE_NAME:$IMAGE_TAG")
                    docker.withRegistry('https://index.docker.io/v1/', DOCKER_CRED_ID) {
                        dockerImage.push()
                    }
                }
            }
        }

        stage('Cleanup Trivy Cache') {
            steps {
                echo 'Cleaning up Trivy cache...'
                sh "rm -rf $TRIVY_CACHE_DIR/*"
            }
        }
        stage('Update Deployment File') {
            environment {
                GIT_REPO_NAME = "java"
                GIT_USER_NAME = "saranya-aws"
            }
            steps {
                withCredentials([usernamePassword(credentialsId: 'github-token', usernameVariable: 'GIT_USER', 
                passwordVariable: 'GIT_TOKEN')]) {
                    sh """
                        echo 'Update Deployment File...'
                        git config user.email "rsaranyaa.ece@gmail.com"
                        git config user.name "saranya-aws"
						PREVIOUS_BUILD_NUMBER=\$((BUILD_NUMBER - 1))
                        sed -i "s|saranyamagi/simplejavaproject:\${PREVIOUS_BUILD_NUMBER}|saranyamagi/simplejavaproject:${BUILD_NUMBER}|g" java-manifests/deployment.yaml
                        git pull origin main
                        git add .
                        git commit -m "Update deployment image to version ${BUILD_NUMBER}" || echo "No changes to commit"
                        git push https://\$GIT_USER:\$GIT_TOKEN@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git HEAD:main
                    """
                }
            }
        }
		stage('Remove Local Docker Image') {
            steps {
                echo 'Removing Docker image from local...'
                sh '''
                   docker rmi ${DOCKER_IMAGE} || true
                '''
            }
        }
    } // End of stages

    post {
        always {
            deleteDir()
        }
        success {
            echo "Build, Nexus deploy, Docker build, Trivy scan, and Docker push completed successfully."
        }
        failure {
            echo "Pipeline failed. Check logs for details."
        }
    }
}

